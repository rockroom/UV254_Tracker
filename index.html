<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UV254 Tracker - Zorn Raw</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1F4A7;</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'IBM Plex Sans', 'Segoe UI', system-ui, sans-serif;
    background: #f8fafc; color: #1e293b; line-height: 1.5;
  }
  sub { font-size: 0.65em; }
  button { font-family: inherit; cursor: pointer; }
  input { font-family: inherit; }

  .login-wrap {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; min-height: 100vh; padding: 20px;
  }
  .login-card {
    background: #fff; border-radius: 14px; padding: 40px 32px;
    border: 1px solid #e2e8f0; box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    width: 100%; max-width: 360px; text-align: center;
  }
  .login-icon { font-size: 40px; margin-bottom: 8px; }
  .login-title { font-size: 22px; font-weight: 700; color: #0c4a6e; margin-bottom: 4px; }
  .login-sub { font-size: 14px; color: #64748b; margin-bottom: 24px; }
  .setup-note {
    font-size: 13px; color: #64748b; margin-bottom: 16px;
    line-height: 1.5; background: #f1f5f9; padding: 10px 14px; border-radius: 8px;
  }
  .pin-input {
    width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1;
    border-radius: 8px; font-size: 20px; text-align: center;
    letter-spacing: 0.3em; outline: none; margin-bottom: 12px;
  }
  .pin-input:focus { border-color: #0369a1; }
  .pin-btn {
    width: 100%; padding: 12px 0; background: #0369a1; color: #fff;
    border: none; border-radius: 8px; font-size: 15px; font-weight: 700; margin-top: 4px;
  }
  .pin-btn:hover { background: #075985; }
  .login-error { color: #dc2626; font-size: 13px; margin-bottom: 8px; font-weight: 500; }
  .login-footer { font-size: 12px; color: #94a3b8; margin-top: 24px; letter-spacing: 0.02em; }

  .app { max-width: 700px; margin: 0 auto; padding: 24px 16px 48px; }
  .app.display-mode { max-width: 1100px; }

  .header {
    display: flex; justify-content: space-between; align-items: flex-start;
    margin-bottom: 20px; padding-bottom: 14px; border-bottom: 2px solid #0369a1;
    flex-wrap: wrap; gap: 10px;
  }
  .header-title { font-size: 22px; font-weight: 700; color: #0c4a6e; letter-spacing: -0.02em; }
  .header-sub { font-size: 14px; color: #64748b; margin-top: 4px; }
  .header-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
  .btn-sm {
    padding: 6px 12px; background: #e0f2fe; color: #0369a1;
    border: 1px solid #bae6fd; border-radius: 6px; font-size: 13px;
    font-weight: 600; white-space: nowrap;
  }
  .btn-sm:hover { background: #bae6fd; }
  .btn-sm.active { background: #0369a1; color: #fff; border-color: #0369a1; }

  .card {
    background: #fff; border-radius: 10px; padding: 20px;
    margin-bottom: 16px; border: 1px solid #e2e8f0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .card-title {
    font-size: 15px; font-weight: 700; color: #334155;
    text-transform: uppercase; letter-spacing: 0.04em;
  }

  .chart-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 14px; flex-wrap: wrap; gap: 8px;
  }
  .range-toggle {
    display: flex; gap: 2px; background: #f1f5f9; border-radius: 6px; padding: 2px;
  }
  .range-btn {
    padding: 5px 12px; background: transparent; border: none;
    border-radius: 5px; font-size: 12px; font-weight: 600; color: #64748b;
  }
  .range-btn:hover { color: #334155; }
  .range-btn.active {
    background: #fff; color: #0369a1; box-shadow: 0 1px 2px rgba(0,0,0,0.08);
  }
  .chart-wrap { position: relative; width: 100%; height: 300px; }
  .display-mode .chart-wrap { height: 500px; }
  .empty-chart {
    display: flex; align-items: center; justify-content: center;
    height: 200px; background: #f1f5f9; border-radius: 8px; color: #94a3b8; font-size: 14px;
  }

  .slider-wrap { margin-top: 16px; padding-top: 12px; border-top: 1px solid #f1f5f9; }
  .slider-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
  }
  .slider-date { font-size: 12px; font-weight: 600; color: #475569; min-width: 90px; }
  .slider-label {
    font-size: 11px; color: #94a3b8; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .slider-input {
    width: 100%; height: 6px; appearance: none; -webkit-appearance: none;
    background: linear-gradient(to right, #bae6fd, #0369a1);
    border-radius: 3px; outline: none; cursor: pointer; accent-color: #0369a1;
  }
  .slider-input::-webkit-slider-thumb {
    -webkit-appearance: none; width: 18px; height: 18px;
    background: #0369a1; border-radius: 50%; border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2); cursor: pointer;
  }
  .slider-hint { display: flex; justify-content: flex-end; margin-top: 4px; min-height: 24px; }
  .jump-btn {
    background: none; border: none; color: #0369a1;
    font-size: 12px; font-weight: 600; padding: 2px 0;
  }

  .stats-row {
    display: flex; gap: 10px; margin-top: 16px; padding-top: 14px;
    border-top: 1px solid #f1f5f9; flex-wrap: wrap;
  }
  .stat { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; min-width: 60px; }
  .stat-label {
    font-size: 11px; font-weight: 600; color: #94a3b8;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  .stat-value { font-size: 18px; font-weight: 700; color: #0c4a6e; font-variant-numeric: tabular-nums; }
  .stat-value.alert { color: #dc2626; }

  .tab-row { display: flex; gap: 4px; margin-bottom: 4px; }
  .tab-btn {
    flex: 1; padding: 10px 0; border: none; background: transparent;
    color: #64748b; font-weight: 600; font-size: 14px;
    border-bottom: 2px solid transparent;
  }
  .tab-btn.active { color: #0369a1; border-bottom-color: #0369a1; }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .field { display: flex; flex-direction: column; gap: 4px; }
  .field-label {
    font-size: 12px; font-weight: 600; color: #64748b;
    text-transform: uppercase; letter-spacing: 0.03em;
  }
  .field-input {
    padding: 9px 12px; border: 1px solid #cbd5e1; border-radius: 6px;
    font-size: 15px; outline: none; transition: border-color 0.15s; color: #1e293b;
  }
  .field-input:focus { border-color: #0369a1; }
  .field-input.alert-value { border-color: #fca5a5; background: #fef2f2; }
  .field-readonly {
    padding: 9px 12px; background: #f1f5f9; border-radius: 6px;
    font-size: 15px; color: #475569; border: 1px solid #e2e8f0; font-weight: 500;
  }
  .field-alert { font-size: 12px; color: #dc2626; font-weight: 600; margin-top: 2px; }
  .submit-btn {
    margin-top: 18px; width: 100%; padding: 12px 0;
    background: #0369a1; color: #fff; border: none;
    border-radius: 8px; font-size: 15px; font-weight: 700;
  }
  .submit-btn:hover { background: #075985; }
  .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th {
    text-align: left; padding: 8px 10px; border-bottom: 2px solid #e2e8f0;
    font-size: 11px; font-weight: 700; color: #94a3b8;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  td { padding: 10px; color: #334155; }
  tr.alert-row { background: #fef2f2; }
  tr + tr { border-top: 1px solid #f1f5f9; }
  .val-cell { text-align: right; font-variant-numeric: tabular-nums; font-weight: 600; }
  .val-cell.alert { color: #dc2626; }
  .del-btn {
    background: none; border: none; color: #cbd5e1; font-size: 14px; padding: 2px 6px; border-radius: 4px;
  }
  .del-btn:hover { color: #94a3b8; }
  .confirm-row { display: flex; gap: 4px; justify-content: center; }
  .confirm-yes {
    background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;
    border-radius: 4px; font-size: 12px; font-weight: 600; padding: 2px 8px;
  }
  .confirm-no {
    background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0;
    border-radius: 4px; font-size: 12px; font-weight: 600; padding: 2px 8px;
  }

  .banner {
    padding: 8px 14px; border-radius: 6px; font-size: 13px;
    margin-bottom: 12px; font-weight: 500;
  }
  .banner.success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
  .banner.error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
  .banner.info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }

  .rt-dot {
    width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px;
  }
  .rt-dot.connected { background: #22c55e; box-shadow: 0 0 4px #22c55e; }
  .rt-dot.disconnected { background: #ef4444; }
  .rt-status { font-size: 11px; color: #94a3b8; display: flex; align-items: center; }

  .footer { text-align: center; font-size: 12px; color: #94a3b8; margin-top: 32px; letter-spacing: 0.02em; }

  .spinner {
    width: 32px; height: 32px; border: 3px solid #e2e8f0;
    border-top: 3px solid #0369a1; border-radius: 50%;
    animation: spin 0.8s linear infinite; margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-wrap">
  <div class="login-card">
    <div class="login-icon">&#x1F4A7;</div>
    <h1 class="login-title">UV<sub>254</sub> Tracker</h1>
    <p class="login-sub">Zorn Raw</p>

    <div id="setupMode" class="hidden">
      <p class="setup-note">Set a shared PIN for your team to access this app.</p>
      <input id="setupPin" class="pin-input" type="password" inputmode="numeric"
             placeholder="Create PIN (min 4 digits)" maxlength="8">
      <input id="setupConfirm" class="pin-input" type="password" inputmode="numeric"
             placeholder="Confirm PIN" maxlength="8">
      <div id="setupError" class="login-error hidden"></div>
      <button id="setupBtn" class="pin-btn">Set PIN &amp; Enter</button>
    </div>

    <div id="loginMode" class="hidden">
      <input id="loginPin" class="pin-input" type="password" inputmode="numeric"
             placeholder="Enter PIN" maxlength="8">
      <div id="loginError" class="login-error hidden"></div>
      <button id="loginBtn" class="pin-btn">Unlock</button>
    </div>

    <div id="loginLoading"><div class="spinner"></div></div>
  </div>
  <p class="login-footer">Louisville Water Company &mdash; Water Quality Laboratory</p>
</div>

<!-- MAIN APP -->
<div id="appScreen" class="app hidden">

  <header class="header">
    <div>
      <h1 class="header-title">UV<sub>254</sub> Tracker</h1>
      <p class="header-sub">Zorn Raw &mdash; UV<sub>254</sub> Absorbance (cm<sup>-1</sup>)</p>
    </div>
    <div class="header-actions">
      <span class="rt-status"><span id="rtDot" class="rt-dot disconnected"></span><span id="rtLabel">Connecting</span></span>
      <button id="csvDownloadBtn" class="btn-sm" title="Download CSV">&#x2B07; CSV</button>
      <button id="csvUploadBtn" class="btn-sm" title="Upload CSV">&#x2B06; CSV</button>
      <input id="csvFileInput" type="file" accept=".csv" style="display:none">
      <button id="displayToggle" class="btn-sm" title="Toggle display mode">&#x1F5A5; Display</button>
    </div>
  </header>

  <div id="bannerArea"></div>

  <div class="card">
    <div class="chart-header">
      <h2 class="card-title">UV<sub>254</sub> Trend</h2>
      <div class="range-toggle">
        <button class="range-btn active" data-days="14">14-Day</button>
        <button class="range-btn" data-days="30">30-Day</button>
        <button class="range-btn" data-days="90">90-Day</button>
      </div>
    </div>
    <div id="chartEmpty" class="empty-chart">Enter results below to see the trend.</div>
    <div id="chartContainer" class="chart-wrap hidden">
      <canvas id="trendChart"></canvas>
    </div>

    <div id="sliderWrap" class="slider-wrap hidden">
      <div class="slider-header">
        <span id="sliderStart" class="slider-date"></span>
        <span id="sliderLabelText" class="slider-label"></span>
        <span id="sliderEnd" class="slider-date" style="text-align:right"></span>
      </div>
      <input id="sliderInput" class="slider-input" type="range" min="0" max="100" step="0.5" value="100">
      <div class="slider-hint">
        <button id="jumpLatest" class="jump-btn hidden">Jump to latest &#x2192;</button>
      </div>
    </div>

    <div id="statsRow" class="stats-row hidden">
      <div class="stat"><span class="stat-label">Last</span><span id="statLast" class="stat-value">&mdash;</span></div>
      <div class="stat"><span class="stat-label">Avg</span><span id="statAvg" class="stat-value">&mdash;</span></div>
      <div class="stat"><span class="stat-label">Min</span><span id="statMin" class="stat-value">&mdash;</span></div>
      <div class="stat"><span class="stat-label">Max</span><span id="statMax" class="stat-value">&mdash;</span></div>
      <div class="stat"><span class="stat-label">Alerts</span><span id="statAlerts" class="stat-value">&mdash;</span></div>
    </div>
  </div>

  <div id="entrySection">
    <div class="tab-row">
      <button class="tab-btn active" data-tab="entry">Enter Result</button>
      <button class="tab-btn" data-tab="table">View Data (<span id="recordCount">0</span>)</button>
    </div>

    <div id="panelEntry" class="card">
      <h2 class="card-title">New Result</h2>
      <div id="formError" class="banner error hidden" style="margin-top:12px"></div>
      <div class="form-grid" style="margin-top:14px">
        <div class="field">
          <label class="field-label">Sample Point</label>
          <div class="field-readonly">Zorn Raw</div>
        </div>
        <div class="field">
          <label class="field-label">Analysis</label>
          <div class="field-readonly">UV<sub>254</sub></div>
        </div>
        <div class="field">
          <label class="field-label">Date / Time</label>
          <input id="inputDateTime" class="field-input" type="datetime-local">
        </div>
        <div class="field">
          <label class="field-label">Result (cm<sup>-1</sup>)</label>
          <input id="inputValue" class="field-input" type="number" step="0.001" min="0" max="2" placeholder="0.000">
          <span id="inputAlert" class="field-alert hidden">&#x26A0; Above alert threshold (0.100)</span>
        </div>
        <div class="field">
          <label class="field-label">Analyst (optional)</label>
          <input id="inputAnalyst" class="field-input" type="text" placeholder="Initials or name">
        </div>
      </div>
      <button id="submitBtn" class="submit-btn">Save Result</button>
    </div>

    <div id="panelTable" class="card hidden">
      <h2 class="card-title">All Results</h2>
      <div id="tableEmpty" class="empty-chart" style="height:80px; margin-top:12px">No results recorded yet.</div>
      <div id="tableWrap" class="table-wrap hidden" style="margin-top:12px">
        <table>
          <thead><tr>
            <th>Date / Time</th>
            <th style="text-align:right">UV<sub>254</sub> (cm<sup>-1</sup>)</th>
            <th>Analyst</th>
            <th style="width:60px"></th>
          </tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer class="footer">Louisville Water Company &mdash; Water Quality Laboratory</footer>
</div>

<script>
// ==================================================================
// CONFIGURATION - Update these two values from your Supabase project
// ==================================================================
var SUPABASE_URL = 'https://synmfjinzgwpginntwvt.supabase.co';
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5bm1mamluemd3cGdpbm50d3Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjQxNjksImV4cCI6MjA4NzgwMDE2OX0.2HBGc2Cakur84BWG-BpnyWOqih9RH6EWVzwOVshcYyI';

var ALERT_THRESHOLD = 0.100;
var Y_MIN = 0.025;
var Y_MAX = 0.250;

// ==================================================================
// INIT
// ==================================================================
var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

var allRecords = [];
var chart = null;
var rangeDays = 14;
var sliderPos = 100;
var displayMode = false;
var deleteTarget = null;
var realtimeChannel = null;

// Helpers
var $ = function(sel) { return document.querySelector(sel); };
var $$ = function(sel) { return document.querySelectorAll(sel); };
var show = function(el) { el.classList.remove('hidden'); };
var hide = function(el) { el.classList.add('hidden'); };

function hashPin(pin) {
  var h = 0;
  for (var i = 0; i < pin.length; i++) h = ((h << 5) - h + pin.charCodeAt(i)) | 0;
  return 'ph_' + Math.abs(h).toString(36);
}

function fmtDate(iso) {
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
function fmtDateTime(iso) {
  return new Date(iso).toLocaleDateString('en-US', {
    month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit'
  });
}
function fmtDateFull(iso) {
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function fmtISO(iso) {
  return new Date(iso).toISOString().replace('T', ' ').slice(0, 19);
}
function nowLocal() {
  var d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().slice(0, 16);
}

function showBanner(msg, type, duration) {
  type = type || 'info';
  duration = duration !== undefined ? duration : 5000;
  var area = $('#bannerArea');
  var div = document.createElement('div');
  div.className = 'banner ' + type;
  div.textContent = msg;
  area.prepend(div);
  if (duration) setTimeout(function() { div.remove(); }, duration);
}

// ==================================================================
// PIN / AUTH
// ==================================================================
function initLogin() {
  db.from('app_config').select('value').eq('key', 'pin_hash').single().then(function(result) {
    if (result.data) {
      show($('#loginMode'));
      hide($('#loginLoading'));
      $('#loginPin').focus();
    } else {
      show($('#setupMode'));
      hide($('#loginLoading'));
      $('#setupPin').focus();
    }
  }).catch(function() {
    show($('#setupMode'));
    hide($('#loginLoading'));
    $('#setupPin').focus();
  });
}

function handleLogin() {
  var pin = $('#loginPin').value.replace(/\D/g, '');
  if (pin.length < 4) { showLoginError('login', 'PIN must be at least 4 digits'); return; }
  db.from('app_config').select('value').eq('key', 'pin_hash').single().then(function(result) {
    if (result.data && result.data.value === hashPin(pin)) {
      enterApp();
    } else {
      showLoginError('login', 'Incorrect PIN');
      $('#loginPin').value = '';
      $('#loginPin').focus();
    }
  }).catch(function() { showLoginError('login', 'Error verifying PIN'); });
}

function handleSetup() {
  var pin = $('#setupPin').value.replace(/\D/g, '');
  var confirm = $('#setupConfirm').value.replace(/\D/g, '');
  if (pin.length < 4) { showLoginError('setup', 'PIN must be at least 4 digits'); return; }
  if (!/^\d+$/.test(pin)) { showLoginError('setup', 'PIN must contain only numbers'); return; }
  if (pin !== confirm) { showLoginError('setup', 'PINs do not match'); return; }
  db.from('app_config').upsert({ key: 'pin_hash', value: hashPin(pin) }).then(function() {
    enterApp();
  }).catch(function() { showLoginError('setup', 'Error saving PIN'); });
}

function showLoginError(mode, msg) {
  var el = mode === 'setup' ? $('#setupError') : $('#loginError');
  el.textContent = msg;
  show(el);
}

function enterApp() {
  hide($('#loginScreen'));
  show($('#appScreen'));
  loadData();
  setupRealtime();
}

$('#loginBtn').addEventListener('click', handleLogin);
$('#setupBtn').addEventListener('click', handleSetup);
$('#loginPin').addEventListener('keydown', function(e) { if (e.key === 'Enter') handleLogin(); });
$('#setupPin').addEventListener('keydown', function(e) { if (e.key === 'Enter') $('#setupConfirm').focus(); });
$('#setupConfirm').addEventListener('keydown', function(e) { if (e.key === 'Enter') handleSetup(); });
['#setupPin', '#setupConfirm', '#loginPin'].forEach(function(sel) {
  $(sel).addEventListener('input', function(e) { e.target.value = e.target.value.replace(/\D/g, ''); });
});

// ==================================================================
// DATA
// ==================================================================
function loadData() {
  // Supabase default limit is 1000 rows - fetch all with pagination
  var all = [];
  var pageSize = 1000;

  function fetchPage(from) {
    db.from('uv254_readings')
      .select('*')
      .order('date_time', { ascending: true })
      .range(from, from + pageSize - 1)
      .then(function(result) {
        if (result.error) { showBanner('Error loading data: ' + result.error.message, 'error'); return; }
        var rows = result.data || [];
        all = all.concat(rows);
        if (rows.length === pageSize) {
          // Might be more rows, fetch next page
          fetchPage(from + pageSize);
        } else {
          // All rows fetched
          allRecords = all;
          sliderPos = 100;
          refresh();
        }
      }).catch(function(err) {
        showBanner('Error loading data: ' + err.message, 'error');
      });
  }

  fetchPage(0);
}

function setupRealtime() {
  realtimeChannel = db
    .channel('uv254-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'uv254_readings' }, function() {
      loadData();
    })
    .subscribe(function(status) {
      var dot = $('#rtDot');
      var label = $('#rtLabel');
      if (status === 'SUBSCRIBED') {
        dot.className = 'rt-dot connected';
        label.textContent = 'Live';
      } else {
        dot.className = 'rt-dot disconnected';
        label.textContent = 'Reconnecting';
      }
    });
}

// ==================================================================
// WINDOW CALCULATION
// ==================================================================
function getWindow() {
  var windowMs = rangeDays * 24 * 60 * 60 * 1000;
  var nowMs = Date.now();
  var oldestMs = allRecords.length > 0 ? new Date(allRecords[0].date_time).getTime() : nowMs;
  var earliestEnd = Math.min(oldestMs + windowMs, nowMs);
  var latestEnd = nowMs;
  var totalSlide = latestEnd - earliestEnd;
  var windowEnd = totalSlide > 0 ? earliestEnd + (sliderPos / 100) * totalSlide : latestEnd;
  var windowStart = windowEnd - windowMs;
  return { windowStart: windowStart, windowEnd: windowEnd, canSlide: totalSlide > 0 && allRecords.length > 0 };
}

function getFilteredRecords() {
  var w = getWindow();
  return allRecords.filter(function(r) {
    var t = new Date(r.date_time).getTime();
    return t >= w.windowStart && t <= w.windowEnd;
  });
}

// ==================================================================
// REFRESH ALL UI
// ==================================================================
function refresh() {
  var filtered = getFilteredRecords();
  var w = getWindow();
  var isLatest = sliderPos >= 99;

  $('#recordCount').textContent = allRecords.length;

  if (filtered.length < 2) {
    show($('#chartEmpty'));
    hide($('#chartContainer'));
    $('#chartEmpty').textContent = filtered.length === 0
      ? 'Enter results below to see the trend.'
      : 'Add at least 2 results to display the trend line.';
  } else {
    hide($('#chartEmpty'));
    show($('#chartContainer'));
    updateChart(filtered);
  }

  if (w.canSlide) {
    show($('#sliderWrap'));
    $('#sliderStart').textContent = fmtDateFull(new Date(w.windowStart));
    $('#sliderEnd').textContent = fmtDateFull(new Date(w.windowEnd));
    $('#sliderLabelText').textContent = isLatest ? 'Latest ' + rangeDays + ' days' : rangeDays + '-day window';
    $('#sliderInput').value = sliderPos;
    isLatest ? hide($('#jumpLatest')) : show($('#jumpLatest'));
  } else {
    hide($('#sliderWrap'));
  }

  var values = filtered.map(function(r) { return parseFloat(r.value); });
  if (values.length > 0) {
    show($('#statsRow'));
    var last = values[values.length - 1];
    var avg = values.reduce(function(s, v) { return s + v; }, 0) / values.length;
    var min = Math.min.apply(null, values);
    var max = Math.max.apply(null, values);
    var alerts = values.filter(function(v) { return v >= ALERT_THRESHOLD; }).length;
    $('#statLast').textContent = last.toFixed(3);
    $('#statLast').className = 'stat-value' + (last >= ALERT_THRESHOLD ? ' alert' : '');
    $('#statAvg').textContent = avg.toFixed(3);
    $('#statMin').textContent = min.toFixed(3);
    $('#statMax').textContent = max.toFixed(3);
    $('#statAlerts').textContent = alerts;
    $('#statAlerts').className = 'stat-value' + (alerts > 0 ? ' alert' : '');
  } else {
    hide($('#statsRow'));
  }

  renderTable();
}

// ==================================================================
// CHART
// ==================================================================
function updateChart(filtered) {
  var labels = filtered.map(function(r) { return fmtDate(r.date_time); });
  var data = filtered.map(function(r) { return parseFloat(r.value); });
  var pointColors = data.map(function(v) { return v >= ALERT_THRESHOLD ? '#dc2626' : '#0369a1'; });
  var pointRadii = data.map(function(v) { return v >= ALERT_THRESHOLD ? 5 : 4; });
  var pointBorderColors = data.map(function(v) { return v >= ALERT_THRESHOLD ? '#fecaca' : 'transparent'; });
  var pointBorderWidths = data.map(function(v) { return v >= ALERT_THRESHOLD ? 2 : 0; });
  var avg = data.reduce(function(s, v) { return s + v; }, 0) / data.length;

  var config = {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        borderColor: '#0369a1',
        borderWidth: 2.5,
        pointBackgroundColor: pointColors,
        pointRadius: pointRadii,
        pointBorderColor: pointBorderColors,
        pointBorderWidth: pointBorderWidths,
        pointHoverRadius: 7,
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 2,
        tension: 0.3,
        fill: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0f172a',
          titleFont: { size: 11 },
          bodyFont: { size: 14, weight: 'bold' },
          padding: 10,
          cornerRadius: 6,
          callbacks: {
            title: function(items) { return fmtDateTime(filtered[items[0].dataIndex].date_time); },
            label: function(item) {
              var v = item.raw;
              return v.toFixed(3) + ' cm-1' + (v >= ALERT_THRESHOLD ? '  ALERT' : '');
            }
          }
        },
        annotation: {
          annotations: {
            alertLine: {
              type: 'line', yMin: ALERT_THRESHOLD, yMax: ALERT_THRESHOLD,
              borderColor: '#dc2626', borderWidth: 1.5, borderDash: [8, 4],
              label: {
                display: true, content: 'Alert: ' + ALERT_THRESHOLD,
                position: 'end', backgroundColor: 'transparent',
                color: '#dc2626', font: { size: 11, weight: '600' }
              }
            },
            avgLine: {
              type: 'line', yMin: avg, yMax: avg,
              borderColor: '#94a3b8', borderWidth: 1, borderDash: [4, 4],
              label: {
                display: true, content: 'Avg: ' + avg.toFixed(3),
                position: 'start', backgroundColor: 'transparent',
                color: '#94a3b8', font: { size: 11 }
              }
            }
          }
        }
      },
      scales: {
        x: {
          grid: { color: '#e2e6ea', drawBorder: false },
          ticks: { font: { size: 12 }, color: '#64748b' }
        },
        y: {
          min: Y_MIN, max: Y_MAX,
          grid: { color: '#e2e6ea', drawBorder: false },
          ticks: { font: { size: 12 }, color: '#64748b' },
          title: { display: true, text: 'cm-1', color: '#94a3b8', font: { size: 12 } }
        }
      }
    }
  };

  if (chart) {
    chart.data = config.data;
    chart.options = config.options;
    chart.update();
  } else {
    chart = new Chart($('#trendChart'), config);
  }
}

// ==================================================================
// TABLE
// ==================================================================
function renderTable() {
  var body = $('#tableBody');
  body.innerHTML = '';
  if (allRecords.length === 0) {
    show($('#tableEmpty'));
    hide($('#tableWrap'));
    return;
  }
  hide($('#tableEmpty'));
  show($('#tableWrap'));

  var reversed = allRecords.slice().reverse();
  reversed.forEach(function(r) {
    var v = parseFloat(r.value);
    var isAlert = v >= ALERT_THRESHOLD;
    var tr = document.createElement('tr');
    if (isAlert) tr.className = 'alert-row';
    tr.innerHTML =
      '<td>' + fmtDateTime(r.date_time) + '</td>' +
      '<td class="val-cell' + (isAlert ? ' alert' : '') + '">' + v.toFixed(3) + (isAlert ? ' &#x26A0;' : '') + '</td>' +
      '<td>' + (r.analyst || '&mdash;') + '</td>' +
      '<td style="text-align:center" class="del-cell" data-id="' + r.id + '">' +
        '<button class="del-btn" title="Delete">&#x2715;</button>' +
      '</td>';
    body.appendChild(tr);
  });
}

$('#tableBody').addEventListener('click', function(e) {
  var cell = e.target.closest('.del-cell');
  if (!cell) return;
  var id = cell.dataset.id;

  if (cell.dataset.confirming) {
    if (e.target.classList.contains('confirm-yes')) {
      db.from('uv254_readings').delete().eq('id', id).then(function(result) {
        if (result.error) showBanner('Delete failed: ' + result.error.message, 'error');
        else loadData();
      });
    } else if (e.target.classList.contains('confirm-no')) {
      cell.removeAttribute('data-confirming');
      cell.innerHTML = '<button class="del-btn" title="Delete">&#x2715;</button>';
    }
    return;
  }

  cell.dataset.confirming = 'true';
  cell.innerHTML = '<span class="confirm-row">' +
    '<button class="confirm-yes">Yes</button>' +
    '<button class="confirm-no">No</button>' +
    '</span>';
});

// ==================================================================
// FORM
// ==================================================================
$('#inputDateTime').value = nowLocal();

function checkValueInput() {
  var el = $('#inputValue');
  var v = parseFloat(el.value);
  if (!isNaN(v) && v >= ALERT_THRESHOLD) {
    el.classList.add('alert-value');
    show($('#inputAlert'));
  } else {
    el.classList.remove('alert-value');
    hide($('#inputAlert'));
  }
}

$('#inputValue').addEventListener('input', checkValueInput);
$('#inputValue').addEventListener('change', checkValueInput);
$('#inputValue').addEventListener('keyup', checkValueInput);

$('#submitBtn').addEventListener('click', function() {
  var valStr = $('#inputValue').value;
  if (!valStr || !valStr.trim()) {
    showFormError('Please enter a UV254 value'); return;
  }
  var val = parseFloat(valStr);
  if (isNaN(val) || val < 0 || val > 2) {
    showFormError('UV254 must be between 0.000 and 2.000'); return;
  }
  var dt = $('#inputDateTime').value;
  if (!dt) { showFormError('Date/time is required'); return; }

  hideFormError();
  $('#submitBtn').disabled = true;
  $('#submitBtn').textContent = 'Saving...';

  var row = {
    date_time: new Date(dt).toISOString(),
    value: val,
    analyst: $('#inputAnalyst').value.trim() || '---'
  };
  console.log('Inserting:', JSON.stringify(row));

  db.from('uv254_readings').insert(row).then(function(result) {
    console.log('Insert result:', JSON.stringify(result));
    if (result.error) {
      showFormError('Failed to save: ' + result.error.message);
    } else {
      showBanner('Result saved: ' + val.toFixed(3), 'success');
      $('#inputValue').value = '';
      $('#inputValue').classList.remove('alert-value');
      hide($('#inputAlert'));
      $('#inputDateTime').value = nowLocal();
      loadData();
    }
    $('#submitBtn').disabled = false;
    $('#submitBtn').textContent = 'Save Result';
  }).catch(function(err) {
    console.error('Insert catch:', err);
    showFormError('Failed to save: ' + err.message);
    $('#submitBtn').disabled = false;
    $('#submitBtn').textContent = 'Save Result';
  });
});

$('#inputValue').addEventListener('keydown', function(e) { if (e.key === 'Enter') $('#submitBtn').click(); });
$('#inputAnalyst').addEventListener('keydown', function(e) { if (e.key === 'Enter') $('#submitBtn').click(); });

function showFormError(msg) { var el = $('#formError'); el.textContent = msg; show(el); }
function hideFormError() { hide($('#formError')); }

// ==================================================================
// RANGE TOGGLE
// ==================================================================
$$('.range-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    $$('.range-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    rangeDays = parseInt(btn.dataset.days);
    sliderPos = 100;
    refresh();
  });
});

// ==================================================================
// SLIDER
// ==================================================================
$('#sliderInput').addEventListener('input', function(e) {
  sliderPos = parseFloat(e.target.value);
  refresh();
});
$('#jumpLatest').addEventListener('click', function() { sliderPos = 100; refresh(); });

// ==================================================================
// TABS
// ==================================================================
$$('.tab-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    $$('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    var tab = btn.dataset.tab;
    if (tab === 'entry') { show($('#panelEntry')); hide($('#panelTable')); }
    else { hide($('#panelEntry')); show($('#panelTable')); }
  });
});

// ==================================================================
// DISPLAY MODE
// ==================================================================
$('#displayToggle').addEventListener('click', function() {
  displayMode = !displayMode;
  var app = $('#appScreen');
  var entry = $('#entrySection');
  var toggle = $('#displayToggle');
  if (displayMode) {
    app.classList.add('display-mode');
    hide(entry);
    toggle.classList.add('active');
    toggle.innerHTML = '&#x270F; Entry';
  } else {
    app.classList.remove('display-mode');
    show(entry);
    toggle.classList.remove('active');
    toggle.innerHTML = '&#x1F5A5; Display';
  }
  if (chart) setTimeout(function() { chart.resize(); }, 50);
});

// ==================================================================
// CSV DOWNLOAD
// ==================================================================
$('#csvDownloadBtn').addEventListener('click', function() {
  if (allRecords.length === 0) { showBanner('No data to download.', 'info'); return; }
  var header = 'DateTime,UV254_cm-1,Analyst\n';
  var rows = allRecords.map(function(r) {
    return fmtISO(r.date_time) + ',' + parseFloat(r.value).toFixed(3) + ',' + (r.analyst || '---');
  }).join('\n');
  var blob = new Blob([header + rows], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'ZornRaw_UV254_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
});

// ==================================================================
// CSV UPLOAD
// ==================================================================
$('#csvUploadBtn').addEventListener('click', function() { $('#csvFileInput').click(); });
$('#csvFileInput').addEventListener('change', function(e) {
  var file = e.target.files ? e.target.files[0] : null;
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(ev) {
    try {
      var lines = ev.target.result.split(/\r?\n/).filter(function(l) { return l.trim(); });
      var first = lines[0].toLowerCase();
      var startIdx = (first.indexOf('datetime') >= 0 || first.indexOf('date') >= 0) ? 1 : 0;

      var rows = [];
      var skipped = 0;
      for (var i = startIdx; i < lines.length; i++) {
        var parts = lines[i].split(',');
        if (parts.length < 2) { skipped++; continue; }
        var dt = new Date(parts[0].trim());
        var val = parseFloat(parts[1].trim());
        if (isNaN(dt.getTime()) || isNaN(val)) { skipped++; continue; }
        rows.push({
          date_time: dt.toISOString(),
          value: val,
          analyst: (parts[2] || '').trim() || 'CSV'
        });
      }

      if (rows.length === 0) {
        showBanner('No valid rows. Expected: DateTime, UV254, Analyst (optional)', 'error');
        return;
      }

      // Batch insert in chunks of 500
      var BATCH_SIZE = 500;
      var batches = [];
      for (var b = 0; b < rows.length; b += BATCH_SIZE) {
        batches.push(rows.slice(b, b + BATCH_SIZE));
      }

      showBanner('Importing ' + rows.length + ' rows in ' + batches.length + ' batch(es)...', 'info', 0);

      var batchIndex = 0;
      var totalInserted = 0;
      var totalFailed = 0;

      function insertNextBatch() {
        if (batchIndex >= batches.length) {
          // All done
          $('#bannerArea').innerHTML = '';
          var msg = 'Imported ' + totalInserted + ' record' + (totalInserted !== 1 ? 's' : '');
          if (totalFailed > 0) msg += ' (' + totalFailed + ' failed)';
          if (skipped > 0) msg += ' (' + skipped + ' skipped)';
          showBanner(msg, totalFailed > 0 ? 'error' : 'success');
          loadData();
          return;
        }

        var batch = batches[batchIndex];
        db.from('uv254_readings').insert(batch).then(function(result) {
          if (result.error) {
            totalFailed += batch.length;
          } else {
            totalInserted += batch.length;
          }
          batchIndex++;
          insertNextBatch();
        }).catch(function() {
          totalFailed += batch.length;
          batchIndex++;
          insertNextBatch();
        });
      }

      insertNextBatch();

    } catch (err) {
      showBanner('CSV import failed: ' + (err.message || 'Parse error'), 'error');
    }
    e.target.value = '';
  };
  reader.readAsText(file);
});

// ==================================================================
// BOOT
// ==================================================================
initLogin();
</script>
</body>
</html>
